<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Pub St. Sisinius</title>
    
	<link rel="stylesheet" href="style.css">
</head>

<!--==============================================
 STATISCHES HTML LAYOUT
==================================================-->

<body>
    
<header class="main-header">
    <img src="logo.webp" class="logo" alt="Logo">
    <div class="header-text">
        <h1>Pizzeria Pub St. Sisinius</h1>
		<p id="ort">Laas - Vinschgau</p>	
    </div>
</header>
    
<div class="nav-container">
    <div class="tabs">
        <button class="tab-btn active" id="tab-start" onclick="setTab('start')">Start</button>
        <button class="tab-btn" id="tab-pizzas" onclick="setTab('pizzas')">Pizzakarte</button>
        <button class="tab-btn" id="tab-events" onclick="setTab('events')">Events</button>
        <button class="tab-btn" id="tab-tv" onclick="setTab('tv')">TV-Sport</button>
    </div>
    <div class="lang-switch">
        <button class="lang-btn active" id="btn-de" onclick="setLang('DE')">DE</button>
        <button class="lang-btn" id="btn-it" onclick="setLang('IT')">IT</button>
    </div>
</div>

<div class="container">
    <div id="content-area"></div>
</div>
    
<footer>
    <div class="footer-section">
        <strong>Pizzeria Pub St. Sisinius</strong>
        <span id="footer-address">Vinschgaustra√üe 74, 39023 Laas (BZ)</span>
        <span id="footer-region">S√ºdtirol, Italien)</span>
    </div>
    
    <div class="footer-section">
        <strong id="footer-contact">Kontakt</strong>
        <a href="tel:+393898334004">Tel: +39 389 833 4004</a>
        <span id="footer-mwst" style="opacity: 0.8; font-size: 0.8rem;">MwSt.-Nr.: 03317990210</span>
    </div>

    <div class="footer-section">
        <strong id="footer-rechtliches">Rechtliches</strong>
        <a href="impressumDe.html" id="footer-impressum-link">Impressum / Note Legali</a>
        <a href="datenschutzDe.html" id="footer-datenschutz-link">Datenschutz / Privacy</a>
    </div>
	  <!-- Trennlinie und Copyright -->
    <!-- Diese Box erzwingt eine neue Zeile -->
    <div class="footer-bottom">
        <hr class="footer-divider">
        <p class="copyright-text">
            &copy; 2026 Pizzeria Pub St. Sisinius. Alle Rechte vorbehalten.
        </p>
    </div>
	
</footer>

<script>
 
// 1. STYLE-BLOCK ALS VARIABLE (Ganz oben im Script)
// Wir brechen die Tags auf: '<' + 'style>'
const styleOpen = '<' + 'style>';
const styleClose = '<' + '/' + 'style>';
// Hilfsvariablen f√ºr "gef√§hrliche" Zeichen
const q = "'";  // Ein einfaches Anf√ºhrungszeichen
const dq = '"'; // Ein doppeltes Anf√ºhrungszeichen

const bt = '`'; // Das Backtick-Zeichen als String

const popupStyles = styleOpen + `
    @keyframes bounce { 
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 
        40% {transform: translateY(-5px);} 
        60% {transform: translateY(-3px);} 
    }
    .scroll-hint { 
        position: absolute; bottom: 100px; right: 25px; 
        background: white; padding: 8px 12px; border-radius: 20px; 
        font-size: 13px; color: var(--red); font-weight: bold; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        cursor: pointer; display: flex; align-items: center; gap: 5px; 
        animation: bounce 2s infinite; z-index: 11000; 
        border: 2px solid var(--red); transition: opacity 0.3s, transform 0.2s;
        user-select: none;
    }
    .scroll-hint:active { transform: scale(0.95); }
` + styleClose;






// POPUP
//=========================================================
function renderNoticePopup(data, lang, container) {
    if (!data.notice || !data.notice.active || sessionStorage.getItem('noticeSeen')) return;

    const title = lang === 'DE' ? data.notice.titleDE : data.notice.titleIT;
    const scrollHint = lang === 'DE' ? 'Mehr lesen' : 'Leggi di pi√π';
    
    // Bild-Logik (Notepad++ sicher in einer Zeile)
    //const imageHtml = data.notice.img ? `<img src="${data.notice.img}" style="max-width:100%; border-radius:8px;">` : 'üì¢';
    
	const imageHtml = data.notice.img 
    ? `<img src="${data.notice.img}" style="max-width:100%; max-height:40vh; object-fit:contain; display:block; margin:0 auto 15px; border-radius:8px;">` 
    : 'üì¢';
	
	
	
    // TEXT-LOGIK: Hier muss die Linie wieder rein!
    let rawText = (lang === 'DE' ? data.notice.textDE : data.notice.textIT) || "";
    const formattedText = rawText
        .replace(/\n/g, '<br>') 
        .replace(/%25|%/g, '<div style="display:block; width:80%; height:2px; background-color:var(--red); margin:15px auto; border-radius:2px;"></div>');

    // Wir rufen die externe "Fabrik" auf
    container.innerHTML += getPopupTemplate(title, scrollHint, imageHtml, formattedText);
	
/*	
		// Warte 1,5 Sekunden, dann scrolle sanft 100 Pixel nach unten
	setTimeout(() => {
		const scrollContent = document.getElementById('popup-scroll-content');
		if (scrollContent) {
			scrollContent.scrollBy({
				top: 120, // Pixel-Anzahl
				behavior: 'smooth'
			});
		}
	}, 3000);
*/	
	
}

let editIndex = null; // Speichert, welche Position gerade bearbeitet wird
let data = { start: {}, pizzas: [], events: [], tv: [] };
let currentTab = 'start';
let lang = 'DE';
const editMode = btoa(new URLSearchParams(window.location.search).get('pw')) === 'bGVvbjIyMDg=';  //Base64-Code

if(editMode) document.body.classList.add('admin-mode');

//√ñFFNUNGSZEITEN 
//========================================
// ZEILE L√ñSCHEN
function deleteTime(index) {
    if (confirm("M√∂chten Sie diese √ñffnungszeit wirklich l√∂schen?")) {
        // Entfernt das Element an der Position 'index'
        data.start.zeiten.splice(index, 1);
        saveHoursToDB(data.start.zeiten);
    }
}

// ZEILE VERSCHIEBEN (Richtung: -1 f√ºr hoch, 1 f√ºr runter)
function moveTime(index, direction) {
    const arr = data.start.zeiten;
    const newIndex = index + direction;

    // Pr√ºfen, ob Verschieben m√∂glich ist (nicht √ºber die Grenzen hinaus)
    if (newIndex >= 0 && newIndex < arr.length) {
        // Tauscht die beiden Elemente im Array aus
        const temp = arr[index];
        arr[index] = arr[newIndex];
        arr[newIndex] = temp;
        
        saveHoursToDB(arr);
    }
}

// EINZELNE ZEILE BEARBEITEN (‚úé)
async function editSingleTime(idx) {
    const z = data.start.zeiten[idx];
    const tDE = prompt("Tag DE:", z.tagDE || z.tag);
    const tIT = prompt("Giorno IT:", z.tagIT || z.tag);
    const uhr = prompt("Zeit:", z.zeit);

    if (tDE && tIT && uhr) {
        data.start.zeiten[idx] = { tagDE: tDE, tagIT: tIT, zeit: uhr };
        await save();
        render();
    }
}

//-----------------------------------------------------  
  
  

function editItem(idx) {
    const item = data[currentTab][idx];	

	const heightInput = document.getElementById('inImgHeight'); // Pr√ºfe, ob die ID in deinem HTML so hei√üt
	if (heightInput) {
		// Falls in der DB nichts steht, nimm 200 als Standard-Anzeige im Edit-Modus
		heightInput.value = item.imgHeight || 200; 
	}
    const heightHandyInput = document.getElementById('inImgHeightHandy'); // Pr√ºfe, ob die ID in deinem HTML so hei√üt
	if (heightHandyInput) {
		// Falls in der DB nichts steht, nimm 100 als Standard-Anzeige im Edit-Modus
		heightHandyInput.value = item.imgHeightHandy || 100; 
	}
    // ... deine anderen Felder (Name, Desc) ...
    let catInput
    // NEU: L√§dt die Liga/Kategorie in das entsprechende Input-Feld
    if (currentTab==="tv"){
	  catInput = document.getElementById('inCat2'); 
	}
	else{
	  catInput = document.getElementById('inCat'); 
	}
    if (catInput) {
        catInput.value = item.cat || ""; 
    }
  
  
    document.getElementById('inNameDE').value = item.nameDE || "";
    document.getElementById('inNameIT').value = item.nameIT || "";
    document.getElementById('inDescDE').value = item.descDE || "";
    document.getElementById('inDescIT').value = item.descIT || "";
    document.getElementById('inRight').value = item.right || "";
    
	// 2. BILD-VORSCHAU AKTUALISIEREN (Der entscheidende Teil!)
    const preview = document.getElementById('img-preview');
    const hiddenInput = document.getElementById('inImgBase64');
    const noImgText = document.getElementById('no-img-text');

    if (item.img && item.img.length > 10) {
        // Falls ein Bild-Code in der MongoDB ist
        if (preview) {
            preview.src = item.img;
            preview.style.display = 'block';
        }
        if (hiddenInput) hiddenInput.value = item.img; // Code f√ºr sp√§teres Speichern vorhalten
        if (noImgText) noImgText.style.display = 'none';
    } else {
        // Falls kein Bild vorhanden ist
        if (preview) {
            preview.src = "";
            preview.style.display = 'none';
        }
        if (hiddenInput) hiddenInput.value = "";
        if (noImgText) noImgText.style.display = 'block';
    }

	// Falls du die Vorschau im Admin-Bereich auch direkt in der H√∂he anpassen willst:
	if (preview && item.imgHeight) {
		preview.style.height = item.imgHeight + "px";
		preview.style.objectFit = "cover"; // Sorgt f√ºr eine saubere Vorschau
	}
    // Falls du die Vorschau im Admin-Bereich auch direkt in der H√∂he anpassen willst:
	if (preview && item.imgHeightHandy) {
		preview.style.height = item.imgHeightHandy + "px";
		preview.style.objectFit = "cover"; // Sorgt f√ºr eine saubere Vorschau
	}


    editIndex = idx; // Position speichern!
    // 3. Titel und Scroll-Effekt
    const title = document.getElementById('admin-title');
    if (title) title.innerText = "Eintrag bearbeiten (Position: " + (idx + 1) + ")";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}   
    

    
async function load() {
	try {
		const res = await fetch('/api/data?pw=leon2208');
		const fetchedData = await res.json();
		
		// Sicherstellen, dass 'data' immer die richtige Struktur hat
		data = fetchedData || {};
		if (!data.pizzas) data.pizzas = [];
		if (!data.events) data.events = [];
		if (!data.start) data.start = { img: 'lokal.webp', textDE: 'Willkommen', textIT: 'Benvenuti' };

		render(); // Jetzt wird die Seite garantiert gezeichnet
	} catch (e) {
		console.error("Fehler beim Laden der Daten:", e);
		// Notfall-Plan: Leere Struktur, damit die Seite nicht h√§ngen bleibt
		data = { start: { img: 'lokal.webp', textDE: 'Willkommen' }, pizzas: [], events: [] };
		render();
	}
}

/* async function save() {
	// Wenn wir auf 'start' sind, machen wir einfach gar nichts (da nichts zu √§ndern ist)
	if (currentTab === 'start') return; 
	await fetch('/api/data?pw=leon2208', {
		method: 'POST',
		headers: {'Content-Type': 'application/json'},
		body: JSON.stringify(data)
	});
	render();
}*/
	
	
async function save() {
    // Wir entfernen die Start-Sperre, damit auch √ñffnungszeiten gespeichert werden!
    try {
        const res = await fetch('/api/data?pw=leon2208', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!res.ok) {
            alert("Fehler beim Speichern in der Cloud!");
        }
    } catch (e) {
        console.error("Speicherfehler:", e);
        alert("Verbindung zum Server fehlgeschlagen.");
    }
    // Wir rufen hier KEIN render() auf, das machen wir lieber in der 
    // aufrufenden Funktion (z.B. move oder addItem) nach dem await.
}

function setTab(t) { 
	currentTab = t; 
	document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+t));
	render(); 
}

function setLang(l) { 
	lang = l; 
	
	// 2. WICHTIG: Das 'Gesehen'-Flag f√ºr das Popup l√∂schen!
	// Dadurch wird das Popup beim n√§chsten render() wieder angezeigt.
	sessionStorage.removeItem('noticeSeen');
	
	
	 // Tab-Buttons √ºbersetzen
	const btnStart = document.getElementById('tab-start');
	const btnPizzas = document.getElementById('tab-pizzas');
	const btnEvents = document.getElementById('tab-events');
	const btnTV = document.getElementById('tab-tv');

    if (lang === 'DE') {
        if(btnStart) btnStart.innerText = "Start";
        if(btnPizzas) btnPizzas.innerText = "Pizzakarte";
        if(btnEvents) btnEvents.innerText = "Events";
        if(btnTV) btnTV.innerText = "TV-Sport";
    } else {
        if(btnStart) btnStart.innerText = "Inizio";
        if(btnPizzas) btnPizzas.innerText = "Menu Pizza";
        if(btnEvents) btnEvents.innerText = "Eventi";
        if(btnTV) btnTV.innerText = "Sport TV";
    }
     
    const ort=document.getElementById('ort');
    if (lang === 'DE') {
        if (ort) {
            ort.innerHTML = "Laas - Vinschagau";
        }
	}
	else{
	    if (ort) {
		    ort.innerHTML = "Lasa - Venosta";
		}
	}
	
	
    // Footer-Elemente √ºbersetzen
    const footerHours = document.getElementById('footer-hours');
    const footerAddress = document.getElementById('footer-address');
    
    if (lang === 'DE') {
        if (footerHours) {
            footerHours.innerHTML = "Montag Ruhetag<br>Di-Do: 16:00-00:00<br>Fr-So: 16:00-01:00";
        }
        // Adresse (optional, falls "Vinschgaustra√üe" √ºbersetzt werden soll)
        if (footerAddress) footerAddress.innerText = "Vinschgaustra√üe 74, 39023 Laas (BZ)";
    } else {
        if (footerHours) {
            footerHours.innerHTML = "Luned√¨ giorno di riposo<br>Mar-Gio: 16:00-00:00<br>Ven-Dom: 16:00-01:00";
        }
        if (footerAddress) footerAddress.innerText = "Via Venosta 74, 39023 Lasa (BZ)";
    }
       
	document.getElementById('btn-de').classList.toggle('active', l==='DE');
	document.getElementById('btn-it').classList.toggle('active', l==='IT');
	render(); 
}

function render() {    
	// --- AUTOMATISCHE SORTIERUNG ---
	if (currentTab === 'tv' || currentTab === 'events') {
		data[currentTab].sort((a, b) => {
			let dateStrA, timeStrA, dateStrB, timeStrB;

			if (currentTab === 'tv') {
				// TV: Datum in descDE, Zeit in right
				dateStrA = a.descDE; timeStrA = a.right;
				dateStrB = b.descDE; timeStrB = b.right;
			} else {
				// EVENTS: Datum in right (z.B. "Fr 13.02.26"), Zeit meist in descDE oder gar nicht
				dateStrA = a.right; timeStrA = "00:00"; 
				dateStrB = b.right; timeStrB = "00:00";
			}

			const dA = parseSisiniusDate(dateStrA, timeStrA);
			const dB = parseSisiniusDate(dateStrB, timeStrB);
			return dA - dB;
		});
	}
	
	// --- FOOTER SPRACHUMSTELLUNG ---

	// 1. Elemente abgreifen
	const footerAddr = document.getElementById('footer-address');
	const footerRegion = document.getElementById('footer-region');
	const footerContact = document.getElementById('footer-contact');
	const footerMwst = document.getElementById('footer-mwst');
	const footerRecht = document.getElementById('footer-rechtliches');
	const footerImpLink = document.getElementById('footer-impressum-link');
	const footerDataLink = document.getElementById('footer-datenschutz-link');

	// 2. Texte und Links je nach Sprache setzen
	if (lang === 'DE') {
		if (footerAddr) footerAddr.innerText = "Vinschgaustra√üe 74, 39023 Laas (BZ)";
		if (footerRegion) footerRegion.innerText = "S√ºdtirol, Italien";
		if (footerContact) footerContact.innerText = "Kontakt";
		if (footerMwst) footerMwst.innerText = "Mwst.-Nr.: 03317990210";
		if (footerRecht) footerRecht.innerText = "Rechtliches";
		
		if (footerImpLink) {
			footerImpLink.innerText = "Impressum";
			footerImpLink.href = "impressumDe.html";
		}
		if (footerDataLink) {
			footerDataLink.innerText = "Datenschutz & Cookies";
			footerDataLink.href = "datenschutzDe.html";
		}
	} else {
		// ITALIENISCH (IT)
		if (footerAddr) footerAddr.innerText = "Via Venosta 74, 39023 Lasa (BZ)";
		if (footerRegion) footerRegion.innerText = "Alto Adige, Italia";
		if (footerContact) footerContact.innerText = "Contatto";
		if (footerMwst) footerMwst.innerText = "P.IVA: 03317990210";
		if (footerRecht) footerRecht.innerText = "Informazioni legali";
		
		if (footerImpLink) {
			footerImpLink.innerText = "Note Legali"; // In Italien hei√üt Impressum oft Note Legali
			footerImpLink.href = "impressumIt.html";
		}
		if (footerDataLink) {
			footerDataLink.innerText = "Informativa sulla privacy & Cookie";
			footerDataLink.href = "datenschutzIt.html";
		}
	}
	

	const area = document.getElementById('content-area');
    if (!area) return;
    area.innerHTML = '';

    // Admin-Modus Klasse am Body umschalten
    if (editMode) {
        document.body.classList.add('admin-mode');
    } else {
        document.body.classList.remove('admin-mode');
    }

//ADMIN
// =========================================================
// 2. ADMIN-KONSOLE (Logik & Anzeige)
// =========================================================
	if (editMode && currentTab !== 'start') {
		const label = currentTab === 'pizzas' ? 'Preis' : (currentTab === 'tv' ? 'Uhrzeit' : 'Datum');
		const labelDesc = currentTab === 'tv' ? 'Datum (z.B. Samstag 14.02.26)' : (currentTab === 'events' ? 'Uhrzeit (z.B. ab 20:00 Uhr)' : 'Beschreibung');
		
		const descITField = (currentTab === 'pizzas') 
			? '<input type="text" id="inDescIT" placeholder="Descrizione (IT)">' 
			: '<input type="hidden" id="inDescIT" value="">';

		// Aufruf der externen Admin-Fabrik (siehe unten)
		area.innerHTML += getAdminConsoleHtml(currentTab, label, labelDesc, descITField);
	}

	// =========================================================
	// 1. STARTSEITE (Sonderlayout GAST & ADMIN)
	// =========================================================
	if (currentTab === 'start') {
		area.className = 'list-mode';
		
		// Aufruf der externen Startseiten-Fabrik (siehe unten)
		// Diese enth√§lt Hero, About, Kontakt, Orthofoto, Social-Buttons & Admin-Popup-Box
		area.innerHTML += getStartPageFullLayout(data, lang, editMode);

		// Ruft das Popup auf und √ºbergibt die Daten
		renderNoticePopup(data, lang, area);
		
		return; // Bricht render() hier sauber ab
	}
	
	//---------------------------------------------------------------
	
    // 2. ANDERE SEITEN ALS STARTSEITE 
	//=====================================
    
	
	// a. Pr√ºfen, ob es ein Handy ist (Standard-Breakpoint 768px)
    const isMobile = window.innerWidth <= 768;
	
	// b. Die richtige H√∂he ausw√§hlen
	// Logik: Wenn Handy UND imgHeightHandy da -> nimm imgHeightHandy. 
	// Sonst nimm imgHeight (PC) oder den Standard 200px.
	//const currentHeight=item.imgHeight;
	/*const hPc=data[currentTab].item.imgHeight;
	const hHandy=data[currentTab].item.imgHeightHandy;
	const currentHeight = isMobile && hHandy 
		? hHandy 
		: (hPc || '200');*/

    if (!data[currentTab]) {
        area.innerHTML = '<p>Lade Daten...</p>';
        return;
    }

    // 2.2 LISTEN RENDERING
    // --- FALL 1: PIZZAS ---
    if (currentTab === 'pizzas') {
        // Aufruf der kleinen Hilfsfunktion (Notepad++ bleibt bunt!)
        area.innerHTML += getSectionTitleHtml(lang === 'DE' ? 'Unsere Pizzakarte' : 'Il Nostro Menu Pizza');
        
        const kats = [
            { id: 'pizza', de: 'Pizza', it: 'Pizza' },
            { id: 'bianche', de: 'Pizza Bianca', it: 'Pizze Bianche' },
            { id: 'kinder', de: 'Kinderpizza', it: 'Pizze per bambini' },
            { id: 'extras', de: 'Extras', it: 'Extra' }
        ];

        kats.forEach(kat => {
            const filtered = data.pizzas.filter(p => (p.cat || 'pizza') === kat.id);
            if (filtered.length > 0) {
                // Auch hier: HTML-String durch Funktion ersetzen
                area.innerHTML += getCategoryHeaderHtml(lang === 'DE' ? kat.de : kat.it);
                
                filtered.forEach(item => {
                    const realIdx = data.pizzas.findIndex(p => p === item);
                    area.innerHTML += renderPizzaOrEvent(item, realIdx, true);
                });
            }
        });
        renderNoticePopup(data, lang, area);
    } 
    // --- FALL 2: TV & EVENTS ---
    else {
        const title = currentTab === 'tv' ? 'TV-Sport' : (lang === 'DE' ? 'Events' : 'Eventi');
        
        // Titelbalken f√ºr TV/Events
        area.innerHTML += getSectionTitleHtml(title);
        area.innerHTML += '<div style="grid-column: 1 / -1; width: 100%; margin-top: 5px; border-bottom: 2px solid var(--red); margin-bottom: 20px;"></div>';

        data[currentTab].forEach((item, idx) => {
            const hPc = item.imgHeight;
            const hHandy = item.imgHeightHandy;
            const isMobile = window.innerWidth <= 768;
            const currentHeight = (isMobile && hHandy) ? hHandy : (hPc || '200');

            if (currentTab === 'tv') {
                area.innerHTML += getTvCardHtml(item, idx, lang, currentHeight, getAdminButtonsHtml);
            } else {
                area.innerHTML += renderPizzaOrEvent(item, idx, false);
            }
        });

        renderNoticePopup(data, lang, area);
    }
} // Ende render()




function translateDate(str) {
    if (!str || lang === 'DE') return str;

    // Lange W√∂rter und kurze Abk√ºrzungen in einem Objekt mapping
    const mapping = {
        "Montag": "Luned√¨", "Dienstag": "Marted√¨", "Mittwoch": "Mercoled√¨", 
        "Donnerstag": "Gioved√¨", "Freitag": "Venerd√¨", "Samstag": "Sabato", "Sonntag": "Domenica",
        "Mo": "Lun", "Di": "Mar", "Mi": "Mer", "Do": "Gio", "Fr": "Ven", "Sa": "Sab", "So": "Dom"
    };

    let res = str;
    // Wir sortieren die Keys nach L√§nge (l√§ngste zuerst), um Teil-Fehler zu vermeiden
    Object.keys(mapping).sort((a, b) => b.length - a.length).forEach(deTag => {
        // \b stellt sicher, dass nur das GANZE Wort/K√ºrzel ersetzt wird
        // Damit wird aus "Sa" in "Sabato" kein "Sabbato"!
        const regex = new RegExp("\\b" + deTag + "\\b", "gi");
        res = res.replace(regex, mapping[deTag]);
    });
    
    return res;
}



// 1. Neue Zeile hinzuf√ºgen
/*async function addTimeRow() {
    const tDE = prompt("Tag auf DEUTSCH (z.B. Montag):", "Montag");
    if (!tDE) return;
    const tIT = prompt("Giorno in ITALIANO (p.es. Luned√¨):", "Luned√¨");
    const uhr = prompt("Uhrzeit (Nutze % f√ºr Leerzeichen, z.B. 17:00-22:00):", "17:00-22:00");

    const neueZeile = {
        tagDE: tDE,
        tagIT: tIT,
        zeit: uhr
    };

    if (!data.start.zeiten) data.start.zeiten = [];
    data.start.zeiten.push(neueZeile);
    
    await save(); // Deine save() Funktion zum Server
    render();
}*/

// Hilfsfunktion zum Speichern der gesamten Daten
async function saveAllData() {
    try {
        const response = await fetch('/api/data?pw=leon2208', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (response.ok) { location.reload(); } 
        else { alert("Fehler beim Speichern!"); }
    } catch (err) { console.error(err); }
}

// Zeile l√∂schen
function deleteTimeRow(index) {
    if(confirm(lang === 'DE' ? "Zeile wirklich l√∂schen?" : "Eliminare riga?")) {
        data.start.zeiten.splice(index, 1);
        saveAllData();
    }
}

// Zeile verschieben (hoch/runter)
function moveTimeRow(index, direction) {
    const targetIndex = index + direction;
    if (targetIndex < 0 || targetIndex >= data.start.zeiten.length) return;
    
    const element = data.start.zeiten.splice(index, 1)[0];
    data.start.zeiten.splice(targetIndex, 0, element);
    saveAllData();
}

// Zeile editieren
function editTimeRow(index) {
    const z = data.start.zeiten[index];
    const newTagDE = prompt("Tag (DE):", z.tagDE || z.tag);
    const newTagIT = prompt("Giorno (IT):", z.tagIT || z.tag);
    const newZeit = prompt("Zeit / Orario:", z.zeit);
    
    if (newTagDE !== null && newTagIT !== null && newZeit !== null) {
        data.start.zeiten[index] = {
            tagDE: newTagDE,
            tagIT: newTagIT,
            zeit: newZeit
        };
        saveAllData();
    }
}

// Neue Zeile hinzuf√ºgen (Erweiterung deiner bestehenden Funktion)
function addTimeRow() {
    if (!data.start.zeiten) data.start.zeiten = [];
    data.start.zeiten.push({ tagDE: "Neu", tagIT: "Nuovo", zeit: "00:00 - 00:00" });
    saveAllData();
}


 
//√ñffnungszeiten
//=========================================
// 2. In MongoDB speichern
async function saveHoursToDB(newArray) {
    const updatedData = {
        ...data,
        type: "main_data",
        start: { 
            ...data.start, 
            zeiten: newArray 
        }
    };

    try {
        const response = await fetch('/api/data?pw=leon2208', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });

        if (response.ok) {
            location.reload(); // Seite in Laas neu laden
        } else {
            alert("Fehler beim Speichern! Status: " + response.status);
        }
    } catch (e) {
        console.error("Netzwerkfehler:", e);
    }
}


// ITEM HINZUF√úGEN
//===================================================
    async function addItem() {
    // 1. Werte aus den Feldern holen
    const newItem = {
        nameDE: document.getElementById('inNameDE').value,
        nameIT: document.getElementById('inNameIT').value,
        descDE: document.getElementById('inDescDE').value,
        descIT: document.getElementById('inDescIT').value,
        right: document.getElementById('inRight').value,
        img: document.getElementById('inImgBase64').value || "",
		//img: document.getElementById('inImg') ? document.getElementById('inImg').value : ""
		imgHeight:document.getElementById('inImgHeight').value || "200", 
		imgHeightHandy:document.getElementById('inImgHeightHandy').value || "100" 
    };

   // WICHTIG: Hier wird die Kategorie ausgelesen
    if (currentTab === 'pizzas' || currentTab === 'tv') {
        const catDropdown = document.getElementById('inCat');
        if (currentTab === 'pizzas'){
		    const catDropdown = document.getElementById('inCat');
			if (catDropdown) {
				newItem.cat = catDropdown.value; // Nimmt 'pizza', 'bianche' oder 'kinder'
			} else {
				 newItem.cat = 'pizza'; // Sicherheits-Fallback				
			}
		}
		if (currentTab === 'tv'){
		     const catTv = document.getElementById('inCatTv');
		     newItem.cat=catTv.value;
			 if (newItem.cat ===""){
               newItem.cat = 'LIVE'; // Sicherheits-Fallback
			 }
		}
    }


    // Sicherheitscheck: Falls Name leer ist
    if (!newItem.nameDE && currentTab !== 'start') {
        alert("Bitte Namen eingeben!");
        return;
    }

    // 2. ENTSCHEIDUNG: Bearbeiten oder Neu?
    if (editIndex !== null) {
        // BEARBEITEN: Bestehenden Index √ºberschreiben
        data[currentTab][editIndex] = newItem;
        console.log("Eintrag an Position " + editIndex + " bearbeitet.");
        editIndex = null; // WICHTIG: Index nach Erfolg zur√ºcksetzen!
    } else {
        // NEU: Nur wenn kein editIndex gesetzt ist, wird gepusht
        if (currentTab === 'start') {
            data.start = newItem; // [newItem]; // Bei Start meist nur ein Eintrag
        } else {
            data[currentTab].push(newItem);
            console.log("Neuer Eintrag am Ende hinzugef√ºgt.");
        }
    }
alert("Sende Wert: " + newItem.imgHeightHandy);
    // 3. SYNCHRONISATION MIT SERVER
    try {
        const res = await fetch('/api/data?pw=leon2208', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            // Felder leeren f√ºr n√§chsten Eintrag
            clearFields();
            alert("Erfolgreich gespeichert!");
            render();
        }
    } catch (e) {
        alert("Fehler beim Speichern!");
    }
}


// √ñffnungszeiten
//============================
async function editStartInfo() {
    // 1. Neue Zeiten vom User abfragen
    const neueZeiten = prompt("Geben Sie die neuen √ñffnungszeiten ein (z.B. Di-Do 16:00-00:00, Fr-Sa...):");
    
    if (neueZeiten) {
        // 2. Das komplette Datenobjekt vorbereiten (muss zu deiner MongoDB Struktur passen)
        const updatedData = {
            ...data, // Beh√§lt alle bestehenden Daten (Pizzas, TV etc.) bei
            type: "main_data",
            start: {
                ...data.start,
                oeffnungszeiten: neueZeiten // Hier wird der neue Wert gesetzt
            }
        };

        // 3. An deine bestehende API senden (Passwort in der URL wegen deiner Route)
        try {
            const response = await fetch('/api/data?pw=leon2208', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                alert("√ñffnungszeiten aktualisiert!");
                location.reload();
            } else {
                alert("Fehler beim Speichern. Passwort korrekt?");
            }
        } catch (err) {
            console.error(err);
            alert("Verbindung zum Server fehlgeschlagen.");
        }
    }
}



    

    
	// Hilfsfunktion zum Leeren der Felder
	function clearFields() {
		document.getElementById('inNameDE').value = "";
		document.getElementById('inNameIT').value = "";
		document.getElementById('inDescDE').value = "";
		document.getElementById('inDescIT').value = "";
		document.getElementById('inRight').value = "";
		if(document.getElementById('inImg')) document.getElementById('inImg').value = "";
		const title = document.getElementById('admin-title');
		if(title) title.innerText = "Neuen Eintrag hinzuf√ºgen";
	}
	
    /*function move(index, dir) {
        const list = data[currentTab];
        if (index + dir >= 0 && index + dir < list.length) {
            [list[index], list[index + dir]] = [list[index + dir], list[index]];
            save();
        }
    }*/
	
async function move(index, direction) {
    const items = data[currentTab];
    const targetIndex = index + direction;

    // 1. Abbruch, wenn man √ºber den Anfang oder das Ende hinaus will
    if (targetIndex < 0 || targetIndex >= items.length) return;

    // 2. KATEGORIE-CHECK (NUR f√ºr Pizzen!)
    if (currentTab === 'pizzas') {
        const currentCat = items[index].cat || 'pizza';
        const targetCat = items[targetIndex].cat || 'pizza';
        
        // Wenn die Kategorien unterschiedlich sind (z.B. Pizza -> Bianche), Tausch stoppen
        if (currentCat !== targetCat) {
            console.log("Verschieben nur innerhalb der Pizza-Kategorie erlaubt.");
            return; 
        }
    } 
    // HINWEIS: F√ºr 'tv' und 'events' gibt es hier kein 'if', 
    // daher wird dort IMMER getauscht, egal was in 'cat' steht.

    // 3. Tausch im Array (Destructuring-Methode)
    [items[index], items[targetIndex]] = [items[targetIndex], items[index]];

    // 4. In die MongoDB Atlas Cloud speichern & Ansicht erneuern
    await save();
    render(); 
}
  
	
	
	

    function remove(idx) {
        if(confirm('L√∂schen / Eliminare?')) { data[currentTab].splice(idx, 1); render();save(); }
    }

    function editStart() {
        const txt = prompt("Text eingeben / Inserire testo:", lang === 'DE' ? data.start.textDE : data.start.textIT);
        if(txt !== null) {
            if(lang === 'DE') data.start.textDE = txt; else data.start.textIT = txt;
            save();
        }
    }

	function encodeImageFileAsURL(element) {
		const file = element.files[0];
		if (!file) return;

		const reader = new FileReader();
		reader.onload = function(e) {
			const img = new Image();
			img.onload = function() {
				// 1. Leinwand erstellen
				const canvas = document.createElement('canvas');
				const MAX_WIDTH = 800; // Maximale Breite f√ºr die Pizzeria-Webseite
				
				let width = img.width;
				let height = img.height;

				// 2. Proportionen berechnen
				if (width > MAX_WIDTH) {
					height *= MAX_WIDTH / width;
					width = MAX_WIDTH;
				}

				canvas.width = width;
				canvas.height = height;

				// 3. Bild auf Leinwand zeichnen (verkleinern)
				const ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0, width, height);

				// 4. Als komprimiertes JPG exportieren (Qualit√§t 0.7 = 70%)
				const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

				// 5. In das versteckte Feld und die Vorschau schreiben
				document.getElementById('inImgBase64').value = compressedBase64;
				
				const preview = document.getElementById('img-preview');
				if (preview) {
					preview.src = compressedBase64;
					preview.style.display = 'block';
				}
				if (document.getElementById('no-img-text')) document.getElementById('no-img-text').style.display = 'none';
				
				console.log("Bild f√ºr St. Sisinius optimiert: " + Math.round(compressedBase64.length / 1024) + " KB");
			};
			img.src = e.target.result;
		};
		reader.readAsDataURL(file);
	}
		
	

    load();
	
	
	async function importPizzeriaDataComplete() {
    const fullList = [
        { n: "Margherita", p: "7.50", dDE: "Tomaten, Fior di Latte, Basilikum", dIT: "Pomodoro, fior di latte, basilico", c: "pizza" },
        { n: "Marinara", p: "6.50", dDE: "Tomaten, Knoblauch, Oliven√∂l", dIT: "Pomodoro, aglio, olio d¬¥oliva", c: "pizza" },
        { n: "Prosciutto", p: "9.00", dDE: "Tomaten, Fior di Latte, Schinken", dIT: "Pomodoro, fior di latte, prosciutto cotto", c: "pizza" },
        { n: "Prosciutto e funghi", p: "9.50", dDE: "Tomaten, Fior di Latte, Schinken, Champignon", dIT: "Pomodoro, fior di latte, prosciutto cotto, champignon", c: "pizza" },
        { n: "Capricciosa", p: "10.00", dDE: "Tomaten, Fior di Latte, Schinken, Champignon, Artischocken", dIT: "Pomodoro, fior di latte, prosciutto, champignon, carciofi", c: "pizza" },
        { n: "Quattro stagioni", p: "10.50", dDE: "Tomaten, Fior di Latte, Schinken, Champignon, Artischocken, Oliven", dIT: "Pomodoro, fior di latte, prosciutto, champignon, carciofi, olive", c: "pizza" },
        { n: "Diavola", p: "10.00", dDE: "Tomaten, Fior di Latte, scharfe Salami, Lombardi", dIT: "Pomodoro, fior di latte, salame piccante, lombardi", c: "pizza" },
        { n: "Siciliana", p: "10.00", dDE: "Tomaten, Fior di latte, Oliven, Kapern, Sardellen", dIT: "Pomodoro, fior di latte, olive, capperi, acciughe", c: "pizza" },
        { n: "Quattro formaggi", p: "11.50", dDE: "Tomaten, Fior di latte, Bufala, Gorgonzola, Parmesan", dIT: "Pomodoro, fior di latte, bufala, gorgonzola, parmigiano", c: "pizza" },
        { n: "Meeresfr√ºchte", p: "12.50", dDE: "Tomaten, Fior di latte, Meeresfr√ºchte, Knoblauch, Petersilie", dIT: "Pomodoro, fior di latte, frutti di mare, aglio, prezzemolo", c: "pizza" },
        { n: "Tonno", p: "9.50", dDE: "Tomaten, Fior di latte, Thunfisch, Zwiebel", dIT: "Pomodoro, fior di latte, tonno, cipolla", c: "pizza" },
        { n: "Garnelen", p: "13.00", dDE: "Tomaten, Fior di latte, Garnelen, Cocktailtomaten, Knoblauch", dIT: "Pomodoro, fior di latte, gamberi, pomodorini, aglio", c: "pizza" },
        { n: "Lachs", p: "12.50", dDE: "Tomaten, Fior di latte, Lachs, Zucchini", dIT: "Pomodoro, fior di latte, salmone, zucchine", c: "pizza" },
        { n: "Calzone", p: "10.50", dDE: "Tomaten, Fior di latte, Schinken, Champignon", dIT: "Pomodoro, fior di latte, prosciutto, champignon", c: "pizza" },
        { n: "Bauern", p: "10.00", dDE: "Tomaten, Fior di latte, Speck, Zwiebel, Knoblauch", dIT: "Pomodoro, fior di latte, speck, cipolla, aglio", c: "pizza" },
        { n: "Bufalina", p: "11.50", dDE: "Tomaten, Bufala, Rucola, Cocktailtomaten, Parmesan", dIT: "Pomodoro, bufala, rucola, pomodorini, parmigiano", c: "pizza" },
        { n: "Parma", p: "12.50", dDE: "Tomaten, Fior di latte, Rucola, Cocktailtomaten, Rohschinken, Parmesan", dIT: "Pomodoro, fior di latte, rucola, pomodorini, crudo, parmigiano", c: "pizza" },
        { n: "Gem√ºse", p: "11.00", dDE: "Tomaten, Fior di latte, Gem√ºse, Parmesan, Knoblauch", dIT: "Pomodoro, fior di latte, verdure, parmigiano, aglio", c: "pizza" },
        { n: "Vegana", p: "9.50", dDE: "Tomaten, Gem√ºse, Knoblauch, Oliven√∂l", dIT: "Pomodoro, verdura, aglio, olio d‚Äôoliva", c: "pizza" },
        { n: "Parmigiana", p: "10.50", dDE: "Tomaten, Fior di latte, Melanzane, Parmesan", dIT: "Pomodoro, fior di latte, melanzane, parmigiano", c: "pizza" },
        { n: "Autunno", p: "11.50", dDE: "Tomaten, Fior di latte, Gorgonzola, Speck, Waln√ºsse", dIT: "Pomodoro, fior di latte, gorgonzola, speck, noci", c: "pizza" },
        { n: "Parnetz", p: "11.50", dDE: "Tomaten, Fior di latte, Speck, Pfifferlinge, Spinat, Knoblauch", dIT: "Pomodoro, fior di latte, speck, finferli, spinaci, aglio", c: "pizza" },
        { n: "Primavera", p: "12.00", dDE: "Tomaten, Bufala, Cocktailtomaten, Basilikumpesto, Ricotta", dIT: "Pomodoro, bufala, pomodorini, pesto alla Genovese, ricotta", c: "pizza" },
        { n: "Rustica", p: "12.00", dDE: "Tomaten, Fior di latte, scharfe Salami, Gorgonzola, Zwiebel, Lombardi", dIT: "Pomodoro, fior di latte, salame piccante, gorgonzola, cipolla, lombardi", c: "pizza" },
        { n: "Sisinius", p: "12.50", dDE: "Tomaten, Fior di latte, scharfe Salami, Zwiebel, Paprika, Pfifferlinge, Ei", dIT: "Pomodoro, fior di latte, salame piccante, cipolla, peperoni, finferli, uova", c: "pizza" },
        { n: "Mediterranea", p: "12.00", dDE: "Tomaten, Fior di latte, Artischocken, Cocktailtomaten, Oliven, Ricotta, Parmesan", dIT: "Pomodoro, fior di latte, carciofi, pomodorini, olive, ricotta, parmigiano", c: "pizza" },
        { n: "Vinschger", p: "13.00", dDE: "Tomaten, Fior di latte, Speck, Zwiebel, Gorgonzola, Pfifferlinge, Parmesan, Knoblauch", dIT: "Pomodoro, fior di latte, speck, cipolla, gorgonzola, finferli, parmigiano, aglio", c: "pizza" },
        { n: "Italia", p: "13.50", dDE: "Tomaten, Fior di latte, Cocktailtomaten, Rohschinken, Burrata, Basilikum", dIT: "Pomodoro, fior di latte, pomodorini, crudo, burrata, basilico", c: "pizza" },

        // --- PIZZA BIANCHE ---
        { n: "Genovese", p: "13.00", dDE: "Basilikumpesto, Fior di latte, Cocktailomaten, Rohschinken, Parmesan", dIT: "Pesto alla genovese, fior di latte, pomodorini, crudo, parmigiano", c: "bianche" },
        { n: "Carbonara", p: "12.00", dDE: "Fior di latte, Speck, Ei, Parmesan, Pfeffer", dIT: "Fior di latte, speck, uova, parmigiano, pepe", c: "bianche" },
        { n: "Superba", p: "12.00", dDE: "Pesto, Fior di latte, Cocktailtomaten, Burrata, Basilikum", dIT: "Pesto, fior di latte, pomodorini, burrata, basilico", c: "bianche" },

        // --- KINDERPIZZA ---
        { n: "Micky Maus", p: "5.50", dDE: "Tomaten, Fior di latte", dIT: "Pomodoro, fior di latte", c: "kinder" },
        { n: "Scooby Doo", p: "6.50", dDE: "Tomaten, Fior di latte, milde Salami, Mais", dIT: "Pomodoro, fior di latte, salame, mais", c: "kinder" },
        { n: "Nemo", p: "7.00", dDE: "Tomate, Fior di latte, 2 Zutaten nach Wahl", dIT: "Pomodoro, fior di latte, 2 condimenti a scelta", c: "kinder" },

        // --- EXTRAS ---
        { n: "Kleine Pizza / pizze piccole", p: "1.50", dDE: "Abzug von:", dIT: "meno:", c: "extras" },
        { n: "Extra Zutaten / aggiunte", p: "4.50", dDE: "max +", dIT: "max +", c: "extras" },
        { n: "Glutenfreier Teig / impasto senza glutine", p: "3.00", dDE: "+", dIT: "+", c: "extras" },
        { n: "Laktosefreie Mozarella / mozzarella senza lattosio", p: "2.00", dDE: "+", dIT: "+", c: "extras" }
    ];

    // Wir nehmen die bestehende Liste (Teil 1) und f√ºgen den Rest hinzu
    const formatted = fullList.map(p => ({
        nameDE: p.n, nameIT: p.n, descDE: p.dDE, descIT: p.dIT, right: p.p, cat: p.c, img: ""
    }));

    data.pizzas = [...data.pizzas, ...formatted]; 

    await save(); 
    alert("Komplette Speisekarte inklusive Extras erfolgreich importiert!");
    location.reload();
}



function parseSisiniusDate(dateStr, timeStr) {
    if (!dateStr) return new Date(2099, 0, 1); 

    try {
        // Sucht nach TT.MM. (2 oder 4 Stellen beim Jahr)
        // Erkennt: 13.02.26, 13.02.2026, Freitag 13.02.26 etc.
        const match = dateStr.match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4})/);
        
        if (match) {
            let day = parseInt(match[1]);
            let month = parseInt(match[2]) - 1; // Monate 0-11
            let year = parseInt(match[3]);

            // Wenn das Jahr nur 2 Stellen hat (z.B. 26), machen wir 2026 daraus
            if (year < 100) year += 2000;

            // Uhrzeit "18:00" oder "18.00" oder "18" finden
            const tMatch = (timeStr || "").match(/(\d{1,2})[:.]?(\d{2})?/);
            const hours = tMatch ? parseInt(tMatch[1]) : 0;
            const minutes = tMatch ? parseInt(tMatch[2] || 0) : 0;

            return new Date(year, month, day, hours, minutes);
        }
    } catch (e) {
        console.error("Format-Fehler in Laas:", e);
    }
    // Falls gar kein Datum gefunden wird, ab nach hinten in der Liste
    return new Date(2099, 0, 1);
}	

function encodeNoticeImage(element) {
    const file = element.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 800; 
            let width = img.width;
            let height = img.height;

            if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
            }
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Komprimieren
            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

            // HIER DIE NEUEN IDs NUTZEN!
            document.getElementById('inImgBase64Notice').value = compressedBase64;
            
            const preview = document.getElementById('img-preview-notice');
            if (preview) {
                preview.src = compressedBase64;
                preview.style.display = 'inline-block';
            }
            if (document.getElementById('no-img-text-notice')) {
                document.getElementById('no-img-text-notice').style.display = 'none';
            }
            
            console.log("Popup-Bild optimiert: " + Math.round(compressedBase64.length / 1024) + " KB");
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}


async function saveNoticeSettings___() {
    // 1. Elemente holen
    const activeEl = document.getElementById('edit-notice-active');
    const deEl = document.getElementById('edit-notice-de');
    const itEl = document.getElementById('edit-notice-it');
    const imgEl = document.getElementById('inImgBase64Notice');

    if (!deEl) {
        alert("Fehler: Felder nicht gefunden. Bist du auf dem Start-Tab?");
        return;
    }

    // 2. NUR die Daten im globalen 'data'-Objekt aktualisieren
    data.notice = {
        active: activeEl.checked,
        img: imgEl ? imgEl.value : (data.notice ? data.notice.img : ""),
        textDE: deEl.value,
        textIT: itEl.value
    };

    // 3. Deine vorhandene zentrale save() Funktion nutzen
    await save(); 
    
    // 4. Seite neu laden (wie bei deinen anderen Funktionen)
    alert(lang === 'DE' ? 'Popup-Einstellungen gespeichert!' : 'Impostazioni salvate!');
    location.reload();
}


async function saveNoticeSettings() {
    // 1. Alle Felder pr√§zise auslesen (inklusive der neuen Titel)
    const noticeData = {
        active: document.getElementById('edit-notice-active').checked,
        img: document.getElementById('inImgBase64Notice').value || "",
        titleDE: document.getElementById('edit-notice-title-de').value, // NEU
        titleIT: document.getElementById('edit-notice-title-it').value, // NEU
        textDE: document.getElementById('edit-notice-de').value,
        textIT: document.getElementById('edit-notice-it').value
    };

    // 2. Das globale Daten-Objekt aktualisieren
    // Wir kopieren das bestehende 'data' und f√ºgen 'notice' hinzu
    data.notice = noticeData;

    try {
        // 3. Deine zentrale save() Funktion aufrufen
        // Diese schickt 'data' an /api/data?pw=leon2208
        await save(); 

        // 4. Erfolgsmeldung erzwingen
        alert(lang === 'DE' ? 'Popup erfolgreich gespeichert!' : 'Popup salvato con successo!');
        
        // 5. Seite neu laden, um die √Ñnderungen in der MongoDB zu aktivieren
        location.reload();
    } catch (err) {
        console.error("Fehler beim Speichern:", err);
        alert("Serverfehler: Daten konnten nicht in MongoDB gespeichert werden.");
    }
}

// 3. Die neue Schlie√ü-Funktion (au√üerhalb der render-Funktion platzieren)
/*function closeNoticePopup() {
    // Merken, dass gesehen wurde
    sessionStorage.setItem('noticeSeen', 'true');
    // Aktuelle Sprache speichern
    sessionStorage.setItem('noticeLang', lang); 
    
    const popup = document.getElementById('notice-popup');
    if (popup) popup.remove();
}*/

/*window.closeNoticePopup = function() {
    const popup = document.getElementById('notice-popup');
    if (popup) {
        popup.remove();
        sessionStorage.setItem('noticeSeen', 'true');
    }
};*/


window.closeNoticePopup = function() {
    const popup = document.getElementById('notice-popup');
    const scrollContent = document.getElementById('popup-scroll-content');

    if (popup) {
        // 1. SCHRITT: Nach UNTEN scrollen (z.B. 300 Pixel weiter)
        if (scrollContent) {
            scrollContent.scrollBy({
                top: 300, // Positiver Wert = scrollt nach unten
                behavior: 'smooth'
            });
        }

        // 2. SCHRITT: Warten (0,5 Sek), damit man die Abw√§rtsbewegung sieht
        setTimeout(() => {
            // 3. SCHRITT: Ausfaden
            popup.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            popup.style.opacity = '0';
            popup.style.transform = 'translateY(20px)'; // Karte sinkt leicht ab

            // 4. SCHRITT: Endg√ºltig l√∂schen
            setTimeout(() => {
                popup.remove();
                sessionStorage.setItem('noticeSeen', 'true');
            }, 400);
            
        }, 500); 
    }
};
function showPopup() {
    // 1. Pr√ºfen, ob eine Nachricht aktiv ist und noch nicht gesehen wurde
    if (data.notice && data.notice.active && !sessionStorage.getItem('noticeSeen')) {
        
        // 2. Werte f√ºr die neue "Fabrik" vorbereiten
        const title = lang === 'DE' ? (data.notice.titleDE || 'Wichtige Info') : (data.notice.titleIT || 'Info importante');
        const scrollHint = lang === 'DE' ? 'Mehr lesen' : 'Leggi di pi√π';
        
        // Bild-HTML (PC/Handy sicher)
        const imageHtml = data.notice.img 
            ? `<img src="${data.notice.img}" style="max-width:100%; max-height:40vh; object-fit:contain; display:block; margin:0 auto 15px; border-radius:8px;">` 
            : 'üì¢';
            
        // Text formatieren (Linie % einf√ºgen)
        let rawText = (lang === 'DE' ? data.notice.textDE : data.notice.textIT) || "";
        const formattedText = rawText
            .replace(/\n/g, '<br>') 
            .replace(/%25|%/g, '<div style="display:block; width:80%; height:2px; background-color:var(--red); margin:15px auto; border-radius:2px;"></div>');

        // 3. NUR NOCH DIE NEUE FUNKTION AUFRUFEN
        // Das sorgt daf√ºr, dass alle IDs (popup-scroll-content) vorhanden sind!
        area.innerHTML += getPopupTemplate(title, scrollHint, imageHtml, formattedText);
        
        // Optional: Automatischer kleiner Scroll-Check nach 2 Sek
        setTimeout(() => {
            const sc = document.getElementById('popup-scroll-content');
            if(sc) sc.scrollBy({top: 50, behavior: 'smooth'});
        }, 2000);
    }
}

function removeNoticeImage() {
    // 1. Hidden Input leeren
    document.getElementById('inImgBase64Notice').value = "";
    
    // 2. File Input leeren
    document.getElementById('file-input-notice').value = "";
    
    // 3. Vorschau-Elemente anpassen
    document.getElementById('img-preview-notice').style.display = "none";
    document.getElementById('img-preview-notice').src = "";
    document.getElementById('no-img-text-notice').style.display = "block";
    
    // 4. L√∂sch-Button verstecken
    document.getElementById('btn-remove-notice').style.display = "none";
}


// Hilfsfunktion, um doppelten Code zu vermeiden
// Hilfsfunktion mit automatischer Wochentags-√úbersetzung f√ºr Laas
function renderPizzaOrEvent(item, idx, isPizza) {    
    const isMobile = window.innerWidth <= 768;
	const hPc=item.imgHeight;
	const hHandy=item.imgHeightHandy;
	const currentHeight = isMobile && hHandy 
		? hHandy 
		: (hPc || '200');
	
	
	let displayRight = item.right || '';
    if (!isPizza){
	  if (lang ==='DE'){}else{displayRight=translateDate(displayRight);}
	}
	
    // (Deine Logik...)
   
	const imgHTML = item.img ? '<img src="${item.img}" class="item-img" alt="Bild">' : '';
   
    // KEIN Semikolon direkt nach return!    
	return `
	
	
	<div class="entry">
		${item.img ? `<img src="${item.img}" class="item-img" style="height: ${currentHeight ? currentHeight + 'px' : '200px'} !important; object-fit: fill;" alt="Bild">` : ''}											
		<!--${item.img ? `<img src="${item.img}" class="item-img"  style="height: ${item.imgHeight || '120px'} !important; object-fit: fill;" alt="Bild">` : ''}-->
		
		<div class="entry-content">
			<div class="entry-header">
				<span style="font-weight: bold; font-size: 1.1rem;">
					${lang === 'DE' ? (item.nameDE || '') : (item.nameIT || '')}
				</span>
				
				<span class="price" style="color: var(--red); font-weight: bold; white-space: nowrap;">
					${displayRight}${isPizza ? ' ‚Ç¨' : ''}
				</span>
			</div>

			<div class="desc" style="font-size: 0.9rem; color: #555; font-style: italic; margin: 10px 0; flex-grow: 1;">
				${lang === 'DE' ? (item.descDE || '') : (item.descIT || '')}
			</div>

			${typeof getAdminButtonsHtml === 'function' ? getAdminButtonsHtml(idx) : ''}
		</div>
	</div>
    `; // Hier am Ende ist das Semikolon richtig.
}


// HILFSFUNKTION (Benannt!)  EDIT L√ñSCHEN, VERSCHIEBEN
function getAdminButtonsHtml(idx) {
    if (!editMode) return '';
    return `
        <div class="btn-row admin-only" style="display: flex !important; margin-top:10px;">           
			 <!-- Pfeile NUR im Pizza-Tab anzeigen -->
            ${currentTab === 'pizzas' ? `
			  <button class="btn-ctrl" onclick="move(${idx}, -1)">‚ñ≤</button>
              <button class="btn-ctrl" onclick="move(${idx}, 1)">‚ñº</button>
            ` : ''}			
			<button class="btn-ctrl" style="background:#ffa000" onclick="editItem(${idx})">‚úé</button>
            <button class="btn-ctrl" style="background:#d32f2f" onclick="remove(${idx})">‚úñ</button>
        </div>`;
}



// GANZ UNTEN IN DER DATEI
function getPopupTemplate(title, scrollHint, imageHtml, formattedText) {
    const q = "'"; 
    return `
        ${popupStyles} 
        <div id="notice-popup" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:10000; padding:20px; animation: fadeIn 0.3s ease-out;">
            
            <!-- WICHTIG: Dieses DIV braucht position: relative, damit der Button sich daran orientiert -->
            <div style="position: relative; background:white; border-radius:15px; max-width:450px; width:100%; max-height:90vh; text-align:center; border:4px solid var(--red); box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow:hidden; display:flex; flex-direction:column;">
                
                <!-- 1. Der Button (Absolut innerhalb der Karte positioniert) -->
                <div id="popup-scroll-hint" 
                     class="scroll-hint" 
                     onclick="this.style.opacity=${q}0${q}; this.style.pointerEvents=${q}none${q}; document.getElementById(${q}popup-scroll-content${q}).scrollBy({top: 150, behavior: ${q}smooth${q}});"
                     style="transition: opacity 0.3s ease; z-index: 100;">
                    ${scrollHint} <span style="font-size: 16px;">‚Üì</span>
                </div>

                <!-- 2. Header (Titel) -->
                <div style="padding:20px 20px 10px 20px; flex-shrink:0; background: white; z-index: 10;">
                    <h2 style="color:var(--red); margin:0;">${title}</h2>
                </div>

                <!-- 3. Scroll-Bereich (Bild & Text) -->
                <div id="popup-scroll-content" 
                     onscroll="if(this.scrollTop > 50) document.getElementById(${q}popup-scroll-hint${q}).style.opacity=${q}0${q};" 
                     style="overflow-y:auto; flex-grow:1; padding:0 25px; scroll-behavior: smooth;">
                    
                    ${imageHtml}       
					<div style="font-size:1.1rem; color:#333; font-weight:bold; line-height:1.5; text-align:center; padding-bottom:40px;">
						${formattedText}
					</div>
                </div>

                <!-- 4. Footer (OK Button) -->
                <div style="padding:15px 20px 25px 20px; flex-shrink:0; border-top:1px solid #eee; background: white; z-index: 10;">
                    <button onclick="closeNoticePopup()" style="background:var(--red); color:white; border:none; padding:12px 30px; border-radius:5px; font-weight:bold; cursor:pointer; text-transform:uppercase; width:100%;">
                        OK
                    </button>
                </div>
            </div>
        </div>`;
}

// --- ADMIN KONSOLE FABRIK ---
// GANZ UNTEN IN DER DATEI - Die komplette Admin-Fabrik
function getAdminConsoleHtml(tab, label, labelDesc, descITField) {
    const q = "'"; 
    return `
    <div class="admin-panel" style="display: block; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
        <strong style="color: var(--red);">Admin-Konsole (${tab.toUpperCase()})</strong>
        
        <div class="input-grid" style="margin-top: 10px;">
            <input type="text" id="inNameDE" placeholder="Name/Titel (DE)">
            <input type="text" id="inNameIT" placeholder="Nome/Titolo (IT)">
            <input type="text" id="inDescDE" placeholder="${labelDesc}">
            ${descITField}
            <input type="text" id="inRight" placeholder="${label}">
        </div>

        <!-- BILD & H√ñHEN BEREICH -->
        <div style="margin-top: 15px; border: 1px dashed #ccc; padding: 10px; border-radius: 5px; background: white;">
            <label style="font-weight:bold; font-size: 0.9rem;">Bild & Anzeigeh√∂hen:</label>
            <input type="file" id="inImgFile" onchange="encodeImageFileAsURL(this)" style="width:100%; margin-bottom:10px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <span>PC:</span> <input type="text" id="inImgHeight" placeholder="200" style="width:60px;">
                <span>Handy:</span> <input type="text" id="inImgHeightHandy" placeholder="100" style="width:60px;">
            </div>
            <input type="hidden" id="inImgBase64">
        </div>

        <!-- KATEGORIE-WAHL (WICHTIG: Hier fehlte inCatTv) -->
        ${(tab === 'pizzas' || tab === 'tv') ? `
            <div style="margin-top: 15px; background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee;">
                <label style="font-weight: bold; font-size: 0.9rem;">
                    ${tab === 'pizzas' ? 'Pizza-Kategorie:' : 'Liga / Wettbewerb:'}
                </label>
                ${tab === 'pizzas' ? `
                    <select id="inCat" style="width:100%; padding:8px; margin-top:5px;">
                        <option value="pizza">Standard Pizza</option>
                        <option value="bianche">Pizza Bianche</option>
                        <option value="kinder">Kinderpizza</option>
                        <option value="extras">Extras</option>
                    </select>
                ` : `
                    <!-- DAS FEHLENDE FELD -->
                    <input type="text" id="inCatTv" placeholder="z.B. Champions League oder Serie A" style="width:100%; padding:8px; margin-top:5px;">
                `}
            </div>
        ` : ''}

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="addItem()" style="flex:1; background:#2e7d32; color:white; padding:12px; border-radius:4px; font-weight:bold; cursor:pointer;">Eintrag speichern</button>
            <button onclick="location.reload()" style="flex:1; background:#757575; color:white; padding:12px; border-radius:4px; cursor:pointer;">Abbrechen</button>
        </div>
    </div>`;
}

// --- STARTSEITE VOLL-LAYOUT FABRIK ---
function getStartPageFullLayout(data, lang, editMode) {
    const q = "'"; 

    // 1. ZEITEN-SCHLEIFE GENERIEREN (Saubere vertikale Struktur)
    const zeitenListe = (data.start && data.start.zeiten && data.start.zeiten.length > 0) ? 
        data.start.zeiten.map((z, idx) => `
            <div style="display: block; width: 100%; margin-bottom: 12px; border-bottom: ${editMode ? '1px dashed #ccc' : 'none'}; padding-bottom: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <span style="font-weight: bold; font-size: 1.1rem;">
                        ${lang === 'DE' ? (z.tagDE || z.tag || '') : (z.tagIT || z.tag || '')}
                    </span> 
                    <span style="font-size: 1.1rem;">${z.zeit || ''}</span>
                </div>
                <!-- ADMIN CONTROLS pro Zeile -->
                ${editMode ? `
                <div style="display: flex; gap: 5px; margin-top: 8px; justify-content: flex-end;">
                    <button onclick="editTimeRow(${idx})" style="background:#ffc107; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:11px;">‚úèÔ∏è</button>
                    <button onclick="moveTimeRow(${idx}, -1)" style="background:#6c757d; color:white; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:11px;" ${idx === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button onclick="moveTimeRow(${idx}, 1)" style="background:#6c757d; color:white; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:11px;" ${idx === data.start.zeiten.length - 1 ? 'disabled' : ''}>‚Üì</button>
                    <button onclick="deleteTimeRow(${idx})" style="background:#dc3545; color:white; border:none; border-radius:3px; padding:4px 8px; cursor:pointer; font-size:11px;">üóëÔ∏è</button>
                </div>
                ` : ''}
            </div>
        `).join('') : `<p>${lang === 'DE' ? 'Keine Zeiten hinterlegt.' : 'Nessun orario inserito.'}</p>`;

    // 2. ADMIN-KOMPONENTEN VORBEREITEN
    const adminBox = editMode ? (typeof getAdminPopupBoxHtml === 'function' ? getAdminPopupBoxHtml(data) : '') : '';
    const addTimeBtn = editMode ? `
        <div style="text-align:center; margin: 15px 0;">
            <button onclick="addTimeRow()" style="background-color: #dc3545; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold;">
                + Neue Zeit hinzuf√ºgen
            </button>
        </div>` : '';

    // 3. DAS GESAMTE HTML ZUR√úCKGEBEN
    return `
    <!-- HERO SECTION -->
    <div class="hero" style="height: 500px; position: relative; width: 100vw; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; overflow: hidden; display: flex; align-items: center; justify-content: center; color: white;">
        <img src="lokal.webp" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;">
        <div style="position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); z-index: 1.5;"></div>
        <div style="position: relative; z-index: 2; text-align: center; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); padding: 0 20px;">
            <h2 style="font-size: 2.5rem; margin-bottom: 10px;">${lang === 'DE' ? 'Willkommen bei Pizzeria Pub St. Sisinius' : 'Benvenuti alla Pizzeria Pub St. Sisinius'}</h2>
            <p style="font-size: 1.5rem; font-weight: 500;">${lang === 'DE' ? 'Pizza, Cocktails und Live-Sport' : 'Pizza, cocktail e sport dal vivo'}</p>
        </div>
    </div>

    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 15px;">
        <!-- ABOUT SECTION -->
        <div class="about-section" style="padding: 40px 0; display: flex; gap: 30px; flex-wrap: wrap; align-items: center;">
            <img src="pizza.webp" alt="Pizza" style="max-width: 400px; width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="flex: 1; min-width: 300px; font-size: 1.1rem; line-height: 1.7;">
                ${lang === 'DE' ? 
                    '<p>Genie√üen Sie unsere frische Pizza aus dem Holzofen sowie Cocktails und Events. Wir freuen uns auf Ihren Besuch!</p>' : 
                    '<p>Godetevi le nostre deliziose pizze in un\'atmosfera accogliente. Non vediamo l\'ora di darvi il benvenuto!</p>'
                }
            </div>
        </div>

        <!-- INFO WRAPPER: KONTAKT LINKS | √ñFFNUNGSZEITEN RECHTS -->
        <div style="display: flex; gap: 25px; flex-wrap: wrap; align-items: flex-start; padding: 20px 0;">
            
            <!-- LINKER RAHMEN: KONTAKT -->
            <div class="contact-card-large" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); flex: 1; min-width: 320px; max-width: 450px;">
                <div style="display: flex; justify-content: space-between;">
                    <div style="flex: 1;">
                        <h3 style="color:#dc3545; margin-top: 0; font-size: 1.5rem;">${lang === 'DE' ? 'Kontakt' : 'Contatto'}</h3>
                        <a href="tel:+393898334004" style="font-weight: bold; text-decoration: none; font-size: 1.3rem; color: #333;">+39 389 833 4004</a>
                        <p style="font-size: 0.9rem; font-weight: bold; color: #666; margin-top: 10px;">${lang === 'DE' ? 'Reservierung & Abholung' : 'Prenotazioni & Asporto'}</p>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; align-items: flex-end; width: 110px; gap: 10px;">
                        <!-- GOOGLE MAPS -->
                        <a href="https://www.google.com..." target="_blank" style="text-decoration: none; width: 110px;">
                            <div style="background: white; border: 1px solid #eee; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <img src="orthofoto.jpg" style="width: 100%; height: 80px; object-fit: cover;">
                                <div style="background: #4285F4; color: white; text-align: center; padding: 4px; font-size: 9px; font-weight: bold;">${lang === 'DE' ? 'KARTE' : 'MAPPA'}</div>
                            </div>
                        </a>
                        <!-- SOCIAL BUTTONS -->
                        <a href="https://www.instagram.com" target="_blank" style="text-decoration: none; display: block; width: 105px; background: linear-gradient(45deg, #f09433, #bc1888); color: white; text-align: center; border-radius: 6px; padding: 6px 0; font-size: 10px; font-weight: bold;">üì∏ INSTAGRAM</a>
                        <a href="https://www.facebook.com..." target="_blank" style="text-decoration: none; display: block; width: 105px; background: #1877F2; color: white; text-align: center; border-radius: 6px; padding: 6px 0; font-size: 10px; font-weight: bold;">f FACEBOOK</a>
                    </div>
                </div>
            </div>

            <!-- RECHTER RAHMEN: √ñFFNUNGSZEITEN & EDITOR -->
            <div class="opening-hours-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); flex: 1.8; min-width: 320px;">			
                <h3 style="color:#dc3545; margin-top: 0; border-bottom: 2px solid #f8f9fa; padding-bottom: 15px; margin-bottom: 20px;">
                    ${lang === 'DE' ? '√ñffnungszeiten' : 'Orari di apertura'}
                </h3>
                
                <div style="display: block; width: 100%;">
                    ${zeitenListe}
                </div>

                <!-- ADMIN BEREICH (Popup & Add Button) -->
                ${editMode ? `
                    <div style="margin-top: 25px; border-top: 2px dashed #ffc107; padding-top: 20px;">
                        ${addTimeBtn}
                        <div style="width: 100%;">
                            ${adminBox}
                        </div>
                    </div>
                ` : ''}
            </div>

        </div> <!-- Ende Info Wrapper -->
    </div> <!-- Ende Container -->
    `;
}

function getTvCardHtml(item, idx, lang, currentHeight, getAdminButtonsHtml) {
    // Falls translateDate existiert, nutzen wir es, sonst Fallback
    const textDE = item.descDE || '';
    const textIT = (typeof translateDate === 'function') ? translateDate(textDE) : textDE;
    
    return `
        <div class="event-card">
            <div class="event-date">
                ${lang === 'DE' ? textDE : textIT}
            </div> 					
            <hr class="event-line">
            ${item.img ? `
                <img src="${item.img}" 
                     class="item-img" 
                     style="height: ${currentHeight}px !important; object-fit: fill;" 
                     alt="Bild">
            ` : ''}		
            <div class="event-grid">
                <div class="event-time">${item.right || ''}</div>
                <div class="event-teams">${lang === 'DE' ? (item.nameDE || '') : (item.nameIT || '')}</div>
                <div class="event-league">${item.cat || 'LIVE'}</div>
            </div>
            ${getAdminButtonsHtml(idx)}
        </div>`;
}


// Hilfsfunktion f√ºr Haupt-√úberschriften (Pizzakarte / TV-Sport)
function getSectionTitleHtml(txt) {
    // Wir nutzen hier klassische Anf√ºhrungszeichen statt Backticks, das ist 100% Notepad++ sicher
    return '<div style="grid-column: 1 / -1; width: 100%; text-align: left; margin-bottom: 0px;">' +
           '<h1 style="color: black; margin: 0; padding: 0; font-size: 1.5rem;">' + txt + '</h1>' +
           '</div>';
}

// Hilfsfunktion f√ºr Kategorie-Trenner (Pizza, Bianche etc.)
function getCategoryHeaderHtml(txt) {
    return '<div style="grid-column: 1 / -1; width: 100%; margin-top: 5px; border-bottom: 3px solid var(--red);">' +
           '<h2 style="margin: 0px 0; padding: 10px 0; color: var(--red);">' + txt + '</h2>' +
           '</div>';
}

	
</script>
</body>
</html>

